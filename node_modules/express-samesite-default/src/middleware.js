"use strict";

exports.__esModule = true;
exports.sameSiteCookieMiddleware = sameSiteCookieMiddleware;

var _bowser = _interopRequireDefault(require("bowser"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function isChrome67Plus(req) {
  try {
    const browser = _bowser.default.getParser(req.get('user-agent') || '');

    return browser.satisfies({
      chrome: '>=67',
      chromium: '>=67'
    });
  } catch (err) {
    return false;
  }
}

function sameSiteCookieMiddleware() {
  return (req, res, next) => {
    if (!isChrome67Plus(req)) {
      return next();
    }

    const {
      cookie
    } = res;

    const setCookieWithSameSite = function (name, value, opts, ...args) {
      opts = opts || {};
      opts.sameSite = opts.sameSite || 'None';
      opts.secure = true;
      return cookie.call(this, name, value, opts, ...args);
    }; // $FlowFixMe


    res.cookie = setCookieWithSameSite;
    next();
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1pZGRsZXdhcmUuanMiXSwibmFtZXMiOlsiaXNDaHJvbWU2N1BsdXMiLCJyZXEiLCJicm93c2VyIiwiYm93c2VyIiwiZ2V0UGFyc2VyIiwiZ2V0Iiwic2F0aXNmaWVzIiwiY2hyb21lIiwiY2hyb21pdW0iLCJlcnIiLCJzYW1lU2l0ZUNvb2tpZU1pZGRsZXdhcmUiLCJyZXMiLCJuZXh0IiwiY29va2llIiwic2V0Q29va2llV2l0aFNhbWVTaXRlIiwibmFtZSIsInZhbHVlIiwib3B0cyIsImFyZ3MiLCJzYW1lU2l0ZSIsInNlY3VyZSIsImNhbGwiXSwibWFwcGluZ3MiOiI7Ozs7O0FBRUE7Ozs7QUFNQSxTQUFTQSxjQUFULENBQXdCQyxHQUF4QixFQUF3RDtBQUNwRCxNQUFJO0FBQ0EsVUFBTUMsT0FBTyxHQUFHQyxnQkFBT0MsU0FBUCxDQUFpQkgsR0FBRyxDQUFDSSxHQUFKLENBQVEsWUFBUixLQUF5QixFQUExQyxDQUFoQjs7QUFDQSxXQUFPSCxPQUFPLENBQUNJLFNBQVIsQ0FBa0I7QUFBRUMsTUFBQUEsTUFBTSxFQUFFLE1BQVY7QUFBa0JDLE1BQUFBLFFBQVEsRUFBRTtBQUE1QixLQUFsQixDQUFQO0FBQ0gsR0FIRCxDQUdFLE9BQU9DLEdBQVAsRUFBWTtBQUNWLFdBQU8sS0FBUDtBQUNIO0FBQ0o7O0FBRU0sU0FBU0Msd0JBQVQsR0FBaUQ7QUFDcEQsU0FBTyxDQUFDVCxHQUFELEVBQU1VLEdBQU4sRUFBV0MsSUFBWCxLQUFvQjtBQUN2QixRQUFJLENBQUNaLGNBQWMsQ0FBQ0MsR0FBRCxDQUFuQixFQUEwQjtBQUN0QixhQUFPVyxJQUFJLEVBQVg7QUFDSDs7QUFFRCxVQUFNO0FBQUVDLE1BQUFBO0FBQUYsUUFBYUYsR0FBbkI7O0FBRUEsVUFBTUcscUJBQXFCLEdBQUcsVUFBVUMsSUFBVixFQUFnQkMsS0FBaEIsRUFBdUJDLElBQXZCLEVBQTZCLEdBQUdDLElBQWhDLEVBQTZDO0FBQ3ZFRCxNQUFBQSxJQUFJLEdBQUdBLElBQUksSUFBSSxFQUFmO0FBQ0FBLE1BQUFBLElBQUksQ0FBQ0UsUUFBTCxHQUFnQkYsSUFBSSxDQUFDRSxRQUFMLElBQWlCLE1BQWpDO0FBQ0FGLE1BQUFBLElBQUksQ0FBQ0csTUFBTCxHQUFjLElBQWQ7QUFDQSxhQUFPUCxNQUFNLENBQUNRLElBQVAsQ0FBWSxJQUFaLEVBQWtCTixJQUFsQixFQUF3QkMsS0FBeEIsRUFBK0JDLElBQS9CLEVBQXFDLEdBQUdDLElBQXhDLENBQVA7QUFDSCxLQUxELENBUHVCLENBY3ZCOzs7QUFDQVAsSUFBQUEsR0FBRyxDQUFDRSxNQUFKLEdBQWFDLHFCQUFiO0FBRUFGLElBQUFBLElBQUk7QUFDUCxHQWxCRDtBQW1CSCIsInNvdXJjZXNDb250ZW50IjpbIi8qIEBmbG93ICovXG5cbmltcG9ydCBib3dzZXIgZnJvbSAnYm93c2VyJztcblxuaW1wb3J0IHR5cGUgeyBFeHByZXNzUmVxdWVzdCwgRXhwcmVzc1Jlc3BvbnNlIH0gZnJvbSAnLi90eXBlcyc7XG5cbnR5cGUgTWlkZGxld2FyZSA9IChyZXEgOiBFeHByZXNzUmVxdWVzdCwgcmVzIDogRXhwcmVzc1Jlc3BvbnNlLCBuZXh0IDogRnVuY3Rpb24pID0+IHZvaWQ7XG5cbmZ1bmN0aW9uIGlzQ2hyb21lNjdQbHVzKHJlcSA6IEV4cHJlc3NSZXF1ZXN0KSA6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGJyb3dzZXIgPSBib3dzZXIuZ2V0UGFyc2VyKHJlcS5nZXQoJ3VzZXItYWdlbnQnKSB8fCAnJyk7XG4gICAgICAgIHJldHVybiBicm93c2VyLnNhdGlzZmllcyh7IGNocm9tZTogJz49NjcnLCBjaHJvbWl1bTogJz49NjcnIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2FtZVNpdGVDb29raWVNaWRkbGV3YXJlKCkgOiBNaWRkbGV3YXJlIHtcbiAgICByZXR1cm4gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gICAgICAgIGlmICghaXNDaHJvbWU2N1BsdXMocmVxKSkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgY29va2llIH0gPSByZXM7XG5cbiAgICAgICAgY29uc3Qgc2V0Q29va2llV2l0aFNhbWVTaXRlID0gZnVuY3Rpb24gKG5hbWUsIHZhbHVlLCBvcHRzLCAuLi5hcmdzKSA6IHZvaWQge1xuICAgICAgICAgICAgb3B0cyA9IG9wdHMgfHwge307XG4gICAgICAgICAgICBvcHRzLnNhbWVTaXRlID0gb3B0cy5zYW1lU2l0ZSB8fCAnTm9uZSc7XG4gICAgICAgICAgICBvcHRzLnNlY3VyZSA9IHRydWU7XG4gICAgICAgICAgICByZXR1cm4gY29va2llLmNhbGwodGhpcywgbmFtZSwgdmFsdWUsIG9wdHMsIC4uLmFyZ3MpO1xuICAgICAgICB9O1xuXG4gICAgICAgIC8vICRGbG93Rml4TWVcbiAgICAgICAgcmVzLmNvb2tpZSA9IHNldENvb2tpZVdpdGhTYW1lU2l0ZTtcblxuICAgICAgICBuZXh0KCk7XG4gICAgfTtcbn1cbiJdfQ==